<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ù†Ø´Ø¦ Ø£ÙƒÙˆØ§Ø¯ ØµÙØ­Ø§Øª Ø§Ù„Ù…Ø§Ù†Ù‡ÙˆØ§ - Base64 Ùˆ Data URL</title>
    <style>
        /* ==================================== */
        /* Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© */
        /* ==================================== */
        body { font-family: 'Arial', sans-serif; background-color: #f4f4f9; color: #333; padding: 20px; }
        .container { max-width: 1000px; margin: 20px auto; background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15); }
        h1, h2 { color: #0056b3; text-align: center; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 20px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="text"], textarea, select { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 16px; }
        button { background-color: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; margin: 5px; transition: background-color 0.3s; }
        button:hover { background-color: #0056b3; }
        .chapter-section { border: 1px solid #ddd; padding: 15px; margin-top: 20px; border-radius: 8px; background-color: #f9f9f9; }
        .image-input-group { display: flex; align-items: center; margin-bottom: 10px; }
        .image-input-group label { flex-shrink: 0; width: 80px; }
        .image-input-group input[type="file"] { flex-grow: 1; margin-left: 10px; }
        .result-code-box { margin-top: 30px; padding: 15px; background-color: #e9ecef; border: 1px solid #ced4da; border-radius: 6px; }
        .result-code-box pre { white-space: pre-wrap; word-wrap: break-word; text-align: left; margin: 0; max-height: 400px; overflow-y: auto; }
        .flex-row { display: flex; gap: 15px; }
        .flex-row > div { flex: 1; }
        .preview-container img { max-width: 80px; max-height: 80px; margin: 5px; border: 1px solid #aaa; }

        /* ==================================== */
        /* Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© (Modal) */
        /* ==================================== */
        .modal { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.8); padding-top: 60px; }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 600px; border-radius: 10px; position: relative; }
        .close-btn { color: #aaa; float: left; font-size: 28px; font-weight: bold; position: absolute; top: 10px; left: 10px; }
        .close-btn:hover, .close-btn:focus { color: black; text-decoration: none; cursor: pointer; }
        .phone-emulator { display: flex; flex-direction: column; align-items: center; margin-top: 20px; }
        .emulator-controls { display: flex; justify-content: space-between; width: 100%; margin-bottom: 10px; text-align: right; direction: rtl; }
        .emulator-frame-wrapper { resize: horizontal; overflow: hidden; min-width: 280px; max-width: 90%; height: 600px; border: 12px solid #333; border-radius: 20px; box-shadow: 0 0 20px rgba(0, 0, 0, 0.5); margin-bottom: 10px; }
        .emulator-frame-wrapper iframe { width: 100%; height: 100%; border: none; background-color: #fff; }

        /* ==================================== */
        /* ÙˆØ¶Ø¹ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ (Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¯Ø§Ø®Ù„ Appreciate24) */
        /* ==================================== */
        .app-mode {
            padding: 0; 
            margin: 0; 
            max-width: none; 
            box-shadow: none; 
            border-radius: 0;
            min-height: 100vh; /* Ù„Ø¬Ø¹Ù„ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ØªÙ…Ù„Ø£ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ */
        }
        .app-mode h1, .app-mode .load-section { 
            display: none !important; /* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡ Ø§Ù„ØªÙŠ Ù„Ø§ Ù†Ø­ØªØ§Ø¬Ù‡Ø§ ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ */
        }
        .app-mode .container {
             padding: 10px;
        }

    </style>
</head>
<body>

<div class="container" id="mainContainer">
    <h1>ğŸ“š Ù…Ø­ÙˆÙ‘Ù„ ÙˆÙ…Ù†Ø¸Ù‘Ù… ÙØµÙˆÙ„ Ø§Ù„Ù…Ø§Ù†Ù‡ÙˆØ§</h1>

    <div id="manhwaInfoSection">
        <h2>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø§Ù†Ù‡ÙˆØ§</h2>
        <div class="flex-row">
            <div>
                <label for="manhwaName">Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ù†Ù‡ÙˆØ§:</label>
                <input type="text" id="manhwaName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ù†Ù‡ÙˆØ§ (Ø¶Ø±ÙˆØ±ÙŠ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆØ§Ù„Ø­ÙØ¸)">
            </div>
            <div>
                <label for="manhwaStatus">Ø§Ù„Ø­Ø§Ù„Ø©:</label>
                <select id="manhwaStatus">
                    <option value="Ù…Ø³ØªÙ…Ø±Ø©">Ù…Ø³ØªÙ…Ø±Ø©</option>
                    <option value="Ù…ØªÙˆÙ‚ÙØ©">Ù…ØªÙˆÙ‚ÙØ©</option>
                </select>
            </div>
        </div>
        <label for="manhwaGenre">Ø§Ù„ØªØµÙ†ÙŠÙ (ÙÙˆØ§ØµÙ„ Ø¨ÙŠÙ† Ø§Ù„ØªØµØ§Ù†ÙŠÙ):</label>
        <input type="text" id="manhwaGenre" placeholder="Ù…Ø«Ù„: Ø£ÙƒØ´Ù†ØŒ Ø®ÙŠØ§Ù„ØŒ Ø±ÙˆÙ…Ø§Ù†Ø³ÙŠ">
        <label for="manhwaStory">Ø§Ù„Ù‚ØµØ©/Ø§Ù„Ù…Ù„Ø®Øµ:</label>
        <textarea id="manhwaStory" rows="4" placeholder="Ø§ÙƒØªØ¨ Ù‚ØµØ© Ø§Ù„Ù…Ø§Ù†Ù‡ÙˆØ§ Ù‡Ù†Ø§..."></textarea>
    </div>

    <div id="loadSection" class="load-section">
        <h2>Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø§Ù†Ù‡ÙˆØ§ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„</h2>
        <label for="existingManhwa">Ø§Ø®ØªØ± Ù…Ø§Ù†Ù‡ÙˆØ§ Ù…ÙˆØ¬ÙˆØ¯Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ Ø£Ùˆ Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ§Ø­Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø© (Ø­ÙØ¸ Ù…Ø­Ù„ÙŠ):</label>
        <select id="existingManhwa">
            <option value="">-- Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø§Ù†Ù‡ÙˆØ§ Ø¬Ø¯ÙŠØ¯Ø© --</option>
        </select>
        <button id="loadManhwaBtn">ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø§Ù†Ù‡ÙˆØ§ Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©</button>
        <hr>
    </div>
    
    <h2>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØµÙˆÙ„</h2>
    <div id="chaptersContainer">
        </div>
    
    <button id="addChapterBtn" style="background-color: #28a745;">+ Ø¥Ø¶Ø§ÙØ© ÙØµÙ„ Ø¬Ø¯ÙŠØ¯</button>
    
    <hr>

    <div style="text-align: center; margin-top: 20px;">
        <button id="generateCodeBtn">ØªÙˆÙ„ÙŠØ¯ Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ØµÙˆØ± ÙˆÙƒÙˆØ¯ HTML</button>
        <button id="saveManhwaBtn">Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø§Ù†Ù‡ÙˆØ§ Ù…Ø­Ù„ÙŠØ§Ù‹</button>
        <button id="openPreviewBtn" style="background-color: #007bff;">â–¶ï¸ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ÙƒÙˆØ¯</button> 
    </div>

    <div class="result-code-box">
        <h3>ğŸ“„ ÙƒÙˆØ¯ HTML Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ù„ÙØµÙˆÙ„:</h3>
        <pre id="finalHtmlCode">Ø³ÙŠØ¸Ù‡Ø± Ø§Ù„ÙƒÙˆØ¯ Ù‡Ù†Ø§ Ø¨Ø¹Ø¯ Ø§Ù„ØªÙˆÙ„ÙŠØ¯ ÙˆØ§Ù„Ø­ÙØ¸...</pre>
        <button id="copyCodeBtn" style="margin-top: 10px;">Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯</button>
    </div>
</div>

<div id="previewModal" class="modal">
  <div class="modal-content">
    <span class="close-btn" id="closePreviewBtn">&times;</span> 
    <h2 style="text-align: right; border: none; margin-bottom: 5px;">ØªØ¬Ø±Ø¨Ø© Ø¹Ø±Ø¶ ØµÙØ­Ø© Ø§Ù„Ù…Ø§Ù†Ù‡ÙˆØ§</h2>

    <div class="phone-emulator">
        <div class="emulator-controls">
            <span id="viewportWidth">Ø§Ù„Ø¹Ø±Ø¶: 360px</span>
            <button id="resetViewportBtn" style="background-color: #ffc107; color: #333; padding: 5px 10px; margin: 0;">Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø·</button>
        </div>
        
        <div id="emulatorFrameWrapper" class="emulator-frame-wrapper">
            <iframe id="previewIframe"></iframe>
        </div>
        <p style="font-size: 0.8em; color: #666;">**ÙŠÙ…ÙƒÙ†Ùƒ Ø³Ø­Ø¨ Ø§Ù„Ø­Ø§ÙØ© Ø§Ù„ÙŠØ³Ø±Ù‰ Ù„Ù€ Ø¥Ø·Ø§Ø± Ø§Ù„Ù‡Ø§ØªÙ Ù„ØªØºÙŠÙŠØ± Ø§Ù„Ø¹Ø±Ø¶ (Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„Ù…Ø®ØªÙ„ÙØ©)**</p>
    </div>
  </div>
</div>

<template id="chapterTemplate">
    <div class="chapter-section" data-chapter-id="0">
        <h3>Ø§Ù„ÙØµÙ„ Ø±Ù‚Ù… <span class="chapter-number">1</span></h3>
        <input type="text" class="chapter-name" placeholder="Ø§Ø³Ù… Ø§Ù„ÙØµÙ„ (Ù…Ø«Ø§Ù„: Ø§Ù„ÙØµÙ„ 1)">
        <div class="images-container">
            <div class="image-input-group">
                <label>ØµÙˆØ±Ø© <span class="image-number">1</span>:</label>
                <input type="file" class="file-input" accept="image/*">
                <input type="hidden" class="base64-link" value="">
                <button type="button" class="remove-image-btn" style="background-color: #dc3545; margin-right: 5px;">- Ø¥Ø²Ø§Ù„Ø©</button>
            </div>
        </div>
        <button type="button" class="add-image-btn" style="background-color: #007bff;">+ Ø¥Ø¶Ø§ÙØ© ØµÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
        <button type="button" class="remove-chapter-btn" style="background-color: #dc3545;">- Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ÙØµÙ„</button>
        <div class="preview-container" style="margin-top: 15px; border-top: 1px dashed #ddd; padding-top: 10px;"></div>
    </div>
</template>

<template id="imageInputTemplate">
    <div class="image-input-group">
        <label>ØµÙˆØ±Ø© <span class="image-number">1</span>:</label>
        <input type="file" class="file-input" accept="image/*">
        <input type="hidden" class="base64-link" value="">
        <button type="button" class="remove-image-btn" style="background-color: #dc3545; margin-right: 5px;">- Ø¥Ø²Ø§Ù„Ø©</button>
    </div>
</template>


<script>
    (function() {
        // ===============================================
        //           Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
        // ===============================================

        let manhwaData = {
            name: '',
            story: '',
            genre: '',
            status: 'Ù…Ø³ØªÙ…Ø±Ø©',
            chapters: [] // ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ {id: string, name: string, base64Links: []}
        };
        const chaptersContainer = document.getElementById('chaptersContainer');

        // ===============================================
        //           Ø¯ÙˆÙØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø©
        // ===============================================

        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        function getChapterElements() {
            return chaptersContainer.querySelectorAll('.chapter-section');
        }

        // ===============================================
        //           Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØ§Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø­Ù„ÙŠ (localStorage)
        // ===============================================

        function loadManhwasList() {
            const storedManhwas = localStorage.getItem('manhwas');
            return storedManhwas ? JSON.parse(storedManhwas) : {};
        }

        function saveManhwaData() {
            const name = document.getElementById('manhwaName').value.trim();
            if (!name) {
                alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ù†Ù‡ÙˆØ§ Ù„Ù„Ø­ÙØ¸.");
                return;
            }

            manhwaData.name = name;
            manhwaData.story = document.getElementById('manhwaStory').value;
            manhwaData.genre = document.getElementById('manhwaGenre').value;
            manhwaData.status = document.getElementById('manhwaStatus').value;

            updateManhwaDataFromDOM(); 

            let allManhwas = loadManhwasList();
            allManhwas[name] = JSON.parse(JSON.stringify(manhwaData)); 
            localStorage.setItem('manhwas', JSON.stringify(allManhwas));
            
            alert(`ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø§Ù†Ù‡ÙˆØ§ "${name}" Ø¨Ù†Ø¬Ø§Ø­.`);
            
            populateExistingManhwaDropdown(allManhwas);
        }

        function populateExistingManhwaDropdown(allManhwas) {
            const select = document.getElementById('existingManhwa');
            select.innerHTML = '<option value="">-- Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø§Ù†Ù‡ÙˆØ§ Ø¬Ø¯ÙŠØ¯Ø© --</option>'; 
            
            const manhwaList = allManhwas || loadManhwasList();
            
            for (const name in manhwaList) {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                select.appendChild(option);
            }
        }

        function loadManhwaForEditing() {
            const selectedName = document.getElementById('existingManhwa').value;
            chaptersContainer.innerHTML = '';

            if (!selectedName) {
                manhwaData = { name: '', story: '', genre: '', status: 'Ù…Ø³ØªÙ…Ø±Ø©', chapters: [] };
                document.getElementById('manhwaName').value = '';
                document.getElementById('manhwaStory').value = '';
                document.getElementById('manhwaGenre').value = '';
                document.getElementById('manhwaStatus').value = 'Ù…Ø³ØªÙ…Ø±Ø©';
                
                // Ø¥Ø¶Ø§ÙØ© ÙØµÙ„ Ø§ÙØªØ±Ø§Ø¶ÙŠ ÙˆØ§Ø­Ø¯ Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø¯Ø¡ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ ÙØµÙˆÙ„
                if (getChapterElements().length === 0) {
                     addChapter(null); 
                }
                
                document.getElementById('finalHtmlCode').textContent = 'ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ù„Ù…Ø§Ù†Ù‡ÙˆØ§ Ø¬Ø¯ÙŠØ¯Ø©.';
                return;
            }

            const allManhwas = loadManhwasList();
            if (allManhwas[selectedName]) {
                // Ù†Ø³Ø® Ø¹Ù…ÙŠÙ‚ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                manhwaData = JSON.parse(JSON.stringify(allManhwas[selectedName]));
                
                document.getElementById('manhwaName').value = manhwaData.name;
                document.getElementById('manhwaStory').value = manhwaData.story;
                document.getElementById('manhwaGenre').value = manhwaData.genre;
                document.getElementById('manhwaStatus').value = manhwaData.status;

                // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ ÙØµÙˆÙ„ØŒ Ø£Ø¶Ù ÙØµÙ„Ø§Ù‹ ÙØ§Ø±ØºÙ‹Ø§ØŒ ÙˆØ¥Ù„Ø§ Ù‚Ù… Ø¨ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙØµÙˆÙ„ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
                if (manhwaData.chapters.length === 0) {
                    addChapter(null);
                } else {
                    manhwaData.chapters.forEach(chap => {
                        addChapter(chap); 
                    });
                }
                
                document.getElementById('finalHtmlCode').textContent = 'ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø§Ù†Ù‡ÙˆØ§ Ø¨Ù†Ø¬Ø§Ø­. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø£Ùˆ Ø¥Ø¶Ø§ÙØ© ÙØµÙˆÙ„ Ø¬Ø¯ÙŠØ¯Ø©.';
            }
        }

        // ===============================================
        //           Ø¥Ø¯Ø§Ø±Ø© ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ÙØµÙˆÙ„ ÙˆØ§Ù„ØµÙˆØ± (Template Logic)
        // ===============================================
        
        function addChapter(chapterData = null) {
            const template = document.getElementById('chapterTemplate');
            
            // Ø§Ø³ØªÙ†Ø³Ø§Ø® Ø§Ù„ÙØµÙ„
            const chapterClone = template.content.cloneNode(true).querySelector('.chapter-section');
            const chapterID = chapterData ? chapterData.id : generateUUID();
            
            // ØªÙ‡ÙŠØ¦Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØµÙ„
            chapterClone.setAttribute('data-chapter-id', chapterID);
            
            const chapterNum = getChapterElements().length + 1;
            chapterClone.querySelector('.chapter-number').textContent = chapterNum;
            chapterClone.querySelector('h3').textContent = `Ø§Ù„ÙØµÙ„ Ø±Ù‚Ù… ${chapterNum}`;
            chapterClone.querySelector('.chapter-name').value = chapterData ? chapterData.name : `Ø§Ù„ÙØµÙ„ ${chapterNum}`;

            chaptersContainer.appendChild(chapterClone);

            // Ø±Ø¨Ø· Ø§Ù„Ù€ Listeners Ù„Ù„Ø£Ø²Ø±Ø§Ø± Ø¯Ø§Ø®Ù„ Ø§Ù„ÙØµÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯
            setupChapterListeners(chapterClone);

            // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙˆØ±
            const imagesContainer = chapterClone.querySelector('.images-container');
            
            if (chapterData && chapterData.base64Links.length > 0) {
                // Ø¥Ø²Ø§Ù„Ø© Ø­Ù‚Ù„ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø§Ù„Ø°ÙŠ Ø£ØªÙ‰ Ù…Ø¹ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
                imagesContainer.innerHTML = ''; 
                // Ø¥Ø¶Ø§ÙØ© ØµÙˆØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù…Ù„Ø©
                chapterData.base64Links.forEach((link) => {
                    addImageInput(chapterClone, link);
                });
            } else {
                 // ÙÙ‚Ø· Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù€ IDs ÙˆØ±Ø¨Ø· Ø§Ù„Ù€ Listeners Ù„Ù„ØµÙˆØ±Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ Ø§Ù„Ù…Ø¶Ù…Ù†Ø©
                 const firstImageGroup = imagesContainer.querySelector('.image-input-group');
                 firstImageGroup.setAttribute('data-image-id', generateUUID());
            }
            
            updateChapterNumbers();
        }

        // Ø¯Ø§Ù„Ø© Ø¥Ø¶Ø§ÙØ© Ø­Ù‚Ù„ ØµÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯ (Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ "+ Ø¥Ø¶Ø§ÙØ© ØµÙˆØ±Ø©")
        function addImageInput(chapterElement, base64Link = '') {
            const imagesContainer = chapterElement.querySelector('.images-container');
            const imageTemplate = document.getElementById('imageInputTemplate');
            
            const imageClone = imageTemplate.content.cloneNode(true).querySelector('.image-input-group');
            const imageID = generateUUID();

            imageClone.setAttribute('data-image-id', imageID);
            imageClone.querySelector('.base64-link').value = base64Link;
            
            const removeButton = imageClone.querySelector('.remove-image-btn');
            removeButton.setAttribute('data-image-id', imageID);
            
            imagesContainer.appendChild(imageClone);

            // Ø±Ø¨Ø· Ø§Ù„Ù€ Listeners Ù„Ù„Ù…Ø¯Ø®Ù„Ø§Øª ÙˆØ§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
            setupImageListeners(imageClone);

            // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù‡Ù†Ø§Ùƒ Ø¨ÙŠØ§Ù†Ø§Øª Base64 Ù…Ø­Ù…Ù„Ø©ØŒ Ù‚Ù… Ø¨Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
            if (base64Link) {
                 displayImagePreview(chapterElement.querySelector('.preview-container'), imageID, base64Link);
            }

            updateImageNumbers(chapterElement);
        }

        function removeChapter(chapterElement) {
            const chapterID = chapterElement.getAttribute('data-chapter-id');
            if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø²Ø§Ù„Ø© Ù‡Ø°Ø§ Ø§Ù„ÙØµÙ„ØŸ`)) return;

            if (chapterElement) {
                chapterElement.remove();
                
                manhwaData.chapters = manhwaData.chapters.filter(c => c.id !== chapterID);
                
                updateChapterNumbers();
                alert(`ØªÙ… Ø­Ø°Ù Ø§Ù„ÙØµÙ„ Ø¨Ù†Ø¬Ø§Ø­.`);
            }
        }

        function removeImage(imageGroup) {
            const imageID = imageGroup.getAttribute('data-image-id');
            const chapterElement = imageGroup.closest('.chapter-section');

            if (imageGroup) {
                imageGroup.remove();
                
                const img = chapterElement.querySelector(`.preview-container img[data-image-id="${imageID}"]`);
                if (img) img.remove();
                
                updateImageNumbers(chapterElement);
            }
        }
        
        function updateChapterNumbers() {
            getChapterElements().forEach((chapterElement, index) => {
                const chapterNum = index + 1;
                chapterElement.querySelector('.chapter-number').textContent = chapterNum;
                chapterElement.querySelector('h3').textContent = `Ø§Ù„ÙØµÙ„ Ø±Ù‚Ù… ${chapterNum}`;
                chapterElement.querySelector('.chapter-name').placeholder = `Ø§Ø³Ù… Ø§Ù„ÙØµÙ„ (Ù…Ø«Ø§Ù„: Ø§Ù„ÙØµÙ„ ${chapterNum})`;
                updateImageNumbers(chapterElement);
            });
        }
        
        function updateImageNumbers(chapterElement) {
             chapterElement.querySelectorAll('.image-input-group').forEach((imageGroup, index) => {
                imageGroup.querySelector('.image-number').textContent = index + 1;
                imageGroup.querySelector('.file-input').id = `file-${chapterElement.getAttribute('data-chapter-id')}-${imageGroup.getAttribute('data-image-id')}`;
            });
        }

        function displayImagePreview(previewContainer, imageID, base64String) {
            const img = previewContainer.querySelector(`img[data-image-id="${imageID}"]`) || document.createElement('img');
            img.setAttribute('data-image-id', imageID);
            img.src = base64String;
            
            if (!previewContainer.contains(img)) {
                previewContainer.appendChild(img);
            }
        }

        function previewImageHandler(event) {
            const fileInput = event.target;
            const chapterElement = fileInput.closest('.chapter-section');
            const imageGroup = fileInput.closest('.image-input-group');
            const imageID = imageGroup.getAttribute('data-image-id');
            const file = fileInput.files[0];
            
            const previewContainer = chapterElement.querySelector('.preview-container');
            const base64HiddenInput = imageGroup.querySelector('.base64-link');

            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const base64String = e.target.result;
                    base64HiddenInput.value = base64String; 
                    displayImagePreview(previewContainer, imageID, base64String);
                };
                reader.readAsDataURL(file);
            } else {
                base64HiddenInput.value = '';
                const img = previewContainer.querySelector(`img[data-image-id="${imageID}"]`);
                if (img) img.remove();
            }
        }

        // ===============================================
        //           ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        // ===============================================

        function updateManhwaDataFromDOM() {
            manhwaData.chapters = [];
            
            getChapterElements().forEach((chapterElement, index) => {
                const chapterID = chapterElement.getAttribute('data-chapter-id');
                const chapterName = chapterElement.querySelector('.chapter-name').value.trim();
                
                const base64Links = [];
                chapterElement.querySelectorAll('.image-input-group').forEach(imageGroup => {
                    const base64Input = imageGroup.querySelector('.base64-link');
                    // Ù†Ø¶ÙŠÙ ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ù„Ø¯ÙŠÙ‡ Ù‚ÙŠÙ…Ø© (Ø£ÙŠ ØªÙ… ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø©)
                    if (base64Input.value) {
                        base64Links.push(base64Input.value);
                    }
                });

                if (base64Links.length > 0) {
                    manhwaData.chapters.push({
                        id: chapterID,
                        name: chapterName || `Ø§Ù„ÙØµÙ„ ${index + 1}`,
                        base64Links: base64Links
                    });
                }
            });
        }

        function generateBase64AndCode() {
            if (!document.getElementById('manhwaName').value.trim()) {
                 alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ù†Ù‡ÙˆØ§ Ø£ÙˆÙ„Ø§Ù‹.");
                 return;
            }
            
            updateManhwaDataFromDOM();
            
            let chaptersHtml = '';
            
            manhwaData.chapters.forEach((chapter) => {
                
                const imagesHtml = chapter.base64Links.map(link => 
                    `    <img src="${link}" alt="ØµÙˆØ±Ø© ${chapter.name}">`
                ).join('\n');

                chaptersHtml += `
<div class="chapter">
    <h2>${chapter.name}</h2>
${imagesHtml}
</div>
            `;
            });
            
            const finalCode = `
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${manhwaData.name} - Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ÙØµÙˆÙ„</title>
    <style>
        /* Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø¹Ø±Ø¶ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚/Ø§Ù„Ù…ØªØµÙØ­ */
        body { font-family: 'Arial', sans-serif; background-color: #222; color: #fff; text-align: center; margin: 0; padding: 0; }
        .manhwa-info { background: #333; padding: 20px; border-radius: 0; margin-bottom: 0; }
        .manhwa-info h1 { color: #fff; border-bottom: 1px solid #555; padding-bottom: 10px; margin-bottom: 10px; }
        .chapter img { max-width: 100%; height: auto; display: block; margin: 0 auto 5px auto; }
        .chapter { margin-bottom: 30px; padding: 10px 0; background: #222; }
    </style>
</head>
<body>
    <div class="manhwa-info">
        <h1>${manhwaData.name}</h1>
        <p><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> ${manhwaData.status}</p>
        <p><strong>Ø§Ù„ØªØµÙ†ÙŠÙ:</strong> ${manhwaData.genre}</p>
        <p><strong>Ø§Ù„Ù‚ØµØ©:</strong> ${manhwaData.story}</p>
    </div>

${chaptersHtml}

</body>
</html>
            `;

            document.getElementById('finalHtmlCode').textContent = finalCode.trim();
            
            // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„ØªÙˆÙ„ÙŠØ¯
            saveManhwaData();
            alert("ØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ ÙˆØ­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù…Ø­Ù„ÙŠØ§Ù‹.");
        }

        function copyCode() {
            const codeElement = document.getElementById('finalHtmlCode');
            const textToCopy = codeElement.textContent;
            
            if (!textToCopy || textToCopy.includes('Ø³ÙŠØ¸Ù‡Ø± Ø§Ù„ÙƒÙˆØ¯ Ù‡Ù†Ø§ Ø¨Ø¹Ø¯ Ø§Ù„ØªÙˆÙ„ÙŠØ¯')) {
                 alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙƒÙˆØ¯ Ù„Ù„Ù†Ø³Ø® Ø¨Ø¹Ø¯!');
                 return;
            }
            
            navigator.clipboard.writeText(textToCopy).then(() => {
                alert('ØªÙ… Ù†Ø³Ø® ÙƒÙˆØ¯ HTML Ø¨Ù†Ø¬Ø§Ø­! ÙŠÙ…ÙƒÙ†Ùƒ Ù„ØµÙ‚Ù‡ Ø§Ù„Ø¢Ù† ÙÙŠ Ù…Ø­Ø±Ø± Appreciate24.');
            }).catch(err => {
                console.error('ÙØ´Ù„ ÙÙŠ Ù†Ø³Ø® Ø§Ù„Ù†Øµ: ', err);
                alert('ÙØ´Ù„ ÙÙŠ Ù†Ø³Ø® Ø§Ù„Ù†Øµ. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù†Ø³Ø® ÙŠØ¯ÙˆÙŠØ§Ù‹.');
            });
        }
        
        // ===============================================
        //           Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© (Modal)
        // ===============================================

        let resizeObserver = null;
        function openPreviewModal() {
            const finalCode = document.getElementById('finalHtmlCode').textContent.trim();
            
            if (!finalCode || finalCode === 'Ø³ÙŠØ¸Ù‡Ø± Ø§Ù„ÙƒÙˆØ¯ Ù‡Ù†Ø§ Ø¨Ø¹Ø¯ Ø§Ù„ØªÙˆÙ„ÙŠØ¯ ÙˆØ§Ù„Ø­ÙØ¸...') {
                alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ø£ÙˆÙ„Ø§Ù‹ Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©.");
                return;
            }

            const modal = document.getElementById('previewModal');
            const iframe = document.getElementById('previewIframe');
            
            iframe.contentDocument.open();
            iframe.contentDocument.write(finalCode);
            iframe.contentDocument.close();

            modal.style.display = "block";
            
            const wrapper = document.getElementById('emulatorFrameWrapper');
            // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø¹Ø±Ø¶ ÙŠØ¨Ø¯Ø£ Ø¨Ù‚ÙŠÙ…Ø© Ù…Ø¹Ù‚ÙˆÙ„Ø© ÙÙŠ Ø§Ù„Ù‡Ø§ØªÙ
            wrapper.style.width = window.innerWidth < 400 ? (window.innerWidth - 40) + 'px' : '360px'; 
            updateViewportWidthDisplay();
            
            if (!resizeObserver) {
                resizeObserver = new ResizeObserver(updateViewportWidthDisplay);
                resizeObserver.observe(wrapper);
            }
        }
        
        function closePreviewModal() {
            document.getElementById('previewModal').style.display = "none";
        }

        function updateViewportWidthDisplay() {
            const wrapper = document.getElementById('emulatorFrameWrapper');
            const currentWidth = wrapper.offsetWidth;
            document.getElementById('viewportWidth').textContent = `Ø§Ù„Ø¹Ø±Ø¶: ${currentWidth}px`;
        }
        
        function resetViewport() {
            const wrapper = document.getElementById('emulatorFrameWrapper');
            wrapper.style.width = '360px';
            updateViewportWidthDisplay();
        }
        
        // ===============================================
        //           ÙˆØ¸ÙŠÙØ© ÙˆØ¶Ø¹ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ (App-Mode)
        // ===============================================
        function checkAppMode() {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø±Ø§Ø¨Ø· ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø§Ø±Ø§Ù…ÙŠØªØ± app_mode=true
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('app_mode') === 'true') {
                const container = document.getElementById('mainContainer');
                container.classList.add('app-mode');
                
                // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡ ØºÙŠØ± Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ© ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
                document.getElementById('loadSection').style.display = 'none';
                document.getElementById('manhwaInfoSection').style.display = 'none';
                
                // ØªØºÙŠÙŠØ± Ø¨Ø¹Ø¶ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù„ØªÙƒÙˆÙ† Ø£ÙƒØ«Ø± Ø¨Ø³Ø§Ø·Ø©
                document.getElementById('saveManhwaBtn').textContent = 'Ø­ÙØ¸';
                document.getElementById('openPreviewBtn').style.display = 'none'; 
                
            }
        }
        
        // ===============================================
        //           Ø±Ø¨Ø· Ø§Ù„Ø¯ÙˆØ§Ù„ (Listeners Setup)
        // ===============================================

        // Ø±Ø¨Ø· Ø¯ÙˆØ§Ù„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø¯Ø§Ø®Ù„ ÙØµÙ„ Ù…Ø¹ÙŠÙ†
        function setupChapterListeners(chapterElement) {
            // Ø¥Ø¶Ø§ÙØ© ØµÙˆØ±Ø©
            chapterElement.querySelector('.add-image-btn').addEventListener('click', function() {
                addImageInput(chapterElement);
            });

            // Ø¥Ø²Ø§Ù„Ø© ÙØµÙ„
            chapterElement.querySelector('.remove-chapter-btn').addEventListener('click', function() {
                removeChapter(chapterElement);
            });
            
            // Ø±Ø¨Ø· Ù…Ø¯Ø®Ù„Ø§Øª ÙˆØµÙˆØ± Ø§Ù„ÙØµÙ„ Ø¨Ø§Ù„Ù€ Listeners
            chapterElement.querySelectorAll('.image-input-group').forEach(setupImageListeners);
        }

        // Ø±Ø¨Ø· Ø¯ÙˆØ§Ù„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ù…Ø¯Ø®Ù„ Ø§Ù„ØµÙˆØ±Ø© ÙˆØ­Ù‚Ù„ Ø§Ù„Ù…Ù„Ù
        function setupImageListeners(imageGroup) {
            // Ù…Ø¹Ø§ÙŠÙ†Ø© Ù…Ù„Ù Ø§Ù„ØµÙˆØ±Ø©
            imageGroup.querySelector('.file-input').addEventListener('change', previewImageHandler);

            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØµÙˆØ±Ø©
            imageGroup.querySelector('.remove-image-btn').addEventListener('click', function() {
                removeImage(imageGroup);
            });
        }

        // Ø¯Ø§Ù„Ø© Ù„Ø±Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
        function setupMainListeners() {
            document.getElementById('loadManhwaBtn').addEventListener('click', loadManhwaForEditing);
            document.getElementById('addChapterBtn').addEventListener('click', function() { addChapter(null); });
            document.getElementById('generateCodeBtn').addEventListener('click', generateBase64AndCode);
            document.getElementById('saveManhwaBtn').addEventListener('click', saveManhwaData);
            document.getElementById('openPreviewBtn').addEventListener('click', openPreviewModal);
            document.getElementById('copyCodeBtn').addEventListener('click', copyCode);
            document.getElementById('closePreviewBtn').addEventListener('click', closePreviewModal);
            document.getElementById('resetViewportBtn').addEventListener('click', resetViewport);
            
            document.getElementById('previewModal').addEventListener('click', function(event) {
                if (event.target === this) {
                    closePreviewModal();
                }
            });
        }


        // Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        window.onload = function() {
            checkAppMode(); // ÙØ­Øµ ÙˆØ¶Ø¹ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø£ÙˆÙ„Ø§Ù‹
            setupMainListeners();
            populateExistingManhwaDropdown();
            loadManhwaForEditing();
        };
    })();
</script>

</body>
</html>
