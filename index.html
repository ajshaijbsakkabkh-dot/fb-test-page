<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ููุดุฆ ุฃููุงุฏ ุงููุงูููุง - ุฅุตุฏุงุฑ ุงูุฅุฏุงุฑุฉ ุงูุดุงูู</title>
    <style>
        /* CSS Styles */
        body { font-family: 'Arial', sans-serif; background-color: #f4f4f9; color: #333; padding: 10px; }
        .container { max-width: 1000px; margin: 10px auto; background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); }
        h1, h2 { color: #0056b3; text-align: center; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="text"], textarea, select { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 16px; }
        button { background-color: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; margin: 5px; transition: background-color 0.3s; }
        button:hover { background-color: #0056b3; }
        .chapter-section { border: 1px solid #ddd; padding: 15px; margin-top: 15px; border-radius: 8px; background-color: #f9f9f9; }
        .image-input-group { display: flex; align-items: center; margin-bottom: 8px; }
        .image-input-group label { flex-shrink: 0; width: 60px; }
        .image-input-group input[type="file"] { flex-grow: 1; margin-left: 10px; }
        .result-code-box { margin-top: 20px; padding: 15px; background-color: #e9ecef; border: 1px solid #ced4da; border-radius: 6px; }
        .result-code-box pre { white-space: pre-wrap; word-wrap: break-word; text-align: left; margin: 0; max-height: 300px; overflow-y: auto; }
        .preview-container img { max-width: 60px; max-height: 60px; margin: 3px; border: 1px solid #aaa; }
        .image-management-buttons { margin-bottom: 15px; display: flex; gap: 10px; }
        .app-mode { padding: 0; margin: 0; max-width: none; box-shadow: none; border-radius: 0; min-height: 100vh; }
        .app-mode h1, .app-mode #loadSection, .app-mode .result-code-box { display: none !important; }
        .app-mode .container { padding: 10px; }
        .flex-row { display: flex; gap: 15px; }
        .flex-row > div { flex: 1; }
    </style>
</head>
<body>

<div class="container" id="mainContainer">
    <h1>๐ ููุดุฆ ุฃููุงุฏ ุงููุงูููุง - ุงูุฅุฏุงุฑุฉ ุงูุดุงููุฉ</h1>

    <div id="manhwaInfoSection">
        <h2>ูุนูููุงุช ุงููุงูููุง ุงูุฃุณุงุณูุฉ</h2>
        <input type="text" id="manhwaName" placeholder="ุงุณู ุงููุงูููุง (ุถุฑูุฑู ููุญูุธ ูุงูุชุนุฏูู)">
        
        <div class="flex-row">
            <div>
                <label for="manhwaStatus">ุงูุญุงูุฉ:</label>
                <select id="manhwaStatus">
                    <option value="ูุณุชูุฑุฉ">ูุณุชูุฑุฉ</option>
                    <option value="ูุชูููุฉ">ูุชูููุฉ</option>
                    <option value="ููุชููุฉ">ููุชููุฉ</option>
                </select>
            </div>
            <div>
                 <label for="chapterCount">ุนุฏุฏ ุงููุตูู (ููุนุฑุถ):</label>
                 <input type="text" id="chapterCount" placeholder="ูุซุงู: 50">
            </div>
        </div>
        
        <label for="manhwaGenre">ุงูุชุตููู (ููุงุตู ุจูู ุงูุชุตุงููู):</label>
        <input type="text" id="manhwaGenre" placeholder="ูุซู: ุฃูุดูุ ุฎูุงูุ ุฑููุงูุณู">
        <label for="manhwaStory">ุงููุตุฉ/ุงูููุฎุต:</label>
        <textarea id="manhwaStory" rows="4" placeholder="ุงูุชุจ ูุตุฉ ุงููุงูููุง ููุง..."></textarea>
    </div>

    <div id="loadSection" class="load-section">
        <h2>ุชุญููู/ุญุฐู ูุงูููุง ุณุงุจูุฉ (ุงูุญูุธ ุงููุญูู)</h2>
        <select id="existingManhwa">
            <option value="">-- ุฅูุดุงุก ูุงูููุง ุฌุฏูุฏุฉ --</option>
        </select>
        <button id="loadManhwaBtn">ุชุญููู ุงููุงูููุง ุงููุฎุชุงุฑุฉ</button>
        <button id="deleteManhwaBtn" style="background-color: #dc3545;">ุญุฐู ุงููุงูููุง ุงููุฎุชุงุฑุฉ</button>
        <hr>
    </div>
    
    <h2>ุฅุฏุงุฑุฉ ุงููุตูู</h2>
    <div id="chaptersContainer">
        </div>
    
    <button id="addChapterBtn" style="background-color: #28a745;">+ ุฅุถุงูุฉ ูุตู ุฌุฏูุฏ</button>
    
    <hr>

    <div style="text-align: center; margin-top: 20px;">
        <button id="generateCodeBtn" style="background-color: #17a2b8;">1. ุชูููุฏ ููุฏ HTML ูููุฑุงุกุฉ</button>
        <button id="generateFullCodeBtn" style="background-color: #6c757d;">2. ุชูููุฏ ุงูููุฏ ุงููุงูู (ููุชุญุฏูุซ)</button> 
        <button id="saveManhwaBtn">3. ุญูุธ ุงููุดุฑูุน ูุญููุงู</button>
        <button id="openPreviewBtn" style="background-color: #007bff; display: none;">4. ูุนุงููุฉ ุงูููุฏ</button> 
    </div>

    <div class="result-code-box">
        <h3>๐ ููุฏ HTML ุงูููุงุฆู:</h3>
        <pre id="finalHtmlCode">ุณูุธูุฑ ุงูููุฏ ููุง ุจุนุฏ ุงูุชูููุฏ...</pre>
        <button id="copyCodeBtn" style="margin-top: 10px;">ูุณุฎ ุงูููุฏ</button>
    </div>
</div>

<template id="chapterTemplate">
    <div class="chapter-section" data-chapter-id="0">
        <h3>ุงููุตู ุฑูู <span class="chapter-number">1</span></h3>
        <input type="text" class="chapter-name" placeholder="ุงุณู ุงููุตู (ูุซุงู: ุงููุตู 1)">
        
        <div class="image-management-buttons">
            <button type="button" class="add-image-manual-btn" style="background-color: #28a745;">+ ุตูุฑุฉ ูุฏููุงู</button>
            <button type="button" class="remove-image-manual-btn" style="background-color: #ffc107; color: #333;">- ุตูุฑุฉ ูุฏููุงู</button>
        </div>
        
        <div class="images-container">
            </div>
        
        <label>ุงุฎุชูุงุฑ ุตูุฑ ูุชุนุฏุฏุฉ ูู ุงููุนุฑุถ:</label>
        <input type="file" class="multi-file-input" accept="image/*" multiple>

        <button type="button" class="remove-chapter-btn" style="background-color: #dc3545; margin-top: 10px;">- ุฅุฒุงูุฉ ุงููุตู</button>
        <div class="preview-container" style="margin-top: 15px; border-top: 1px dashed #ddd; padding-top: 10px;"></div>
    </div>
</template>

<template id="imageInputTemplate">
    <div class="image-input-group">
        <label>ุตูุฑุฉ <span class="image-number">1</span>:</label>
        <input type="file" class="file-input" accept="image/*">
        <input type="hidden" class="base64-link" value="">
        <button type="button" class="remove-image-btn" style="background-color: #dc3545; margin-right: 5px;">- ุฅุฒุงูุฉ</button>
    </div>
</template>

<script>
    (function() {
        let manhwaData = { name: '', story: '', genre: '', status: 'ูุณุชูุฑุฉ', chapterCount: '', chapters: [] };
        const chaptersContainer = document.getElementById('chaptersContainer');
        const storageKey = 'manhwas';

        // =================================================================
        // CORE FUNCTIONS
        // =================================================================
        function generateUUID() {
             return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }
        function getChapterElements() { return chaptersContainer.querySelectorAll('.chapter-section'); }
        function loadManhwasList() {
            const storedManhwas = localStorage.getItem(storageKey);
            return storedManhwas ? JSON.parse(storedManhwas) : {};
        }

        function populateExistingManhwaDropdown(allManhwas) {
            const select = document.getElementById('existingManhwa');
            if (!select) return;
            select.innerHTML = '<option value="">-- ุฅูุดุงุก ูุงูููุง ุฌุฏูุฏุฉ --</option>'; 
            const manhwaList = allManhwas || loadManhwasList();
            for (const name in manhwaList) {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                select.appendChild(option);
            }
        }
        
        // =================================================================
        // DATA & UI MANAGEMENT
        // =================================================================

        function saveManhwaData() {
            const name = document.getElementById('manhwaName').value.trim();
            if (!name) { alert("ุงูุฑุฌุงุก ุฅุฏุฎุงู ุงุณู ุงููุงูููุง ููุญูุธ."); return; }
            manhwaData.name = name;
            manhwaData.story = document.getElementById('manhwaStory').value;
            manhwaData.genre = document.getElementById('manhwaGenre').value;
            manhwaData.status = document.getElementById('manhwaStatus').value;
            manhwaData.chapterCount = document.getElementById('chapterCount').value.trim();
            updateManhwaDataFromDOM(); 
            let allManhwas = loadManhwasList();
            allManhwas[name] = JSON.parse(JSON.stringify(manhwaData)); 
            localStorage.setItem(storageKey, JSON.stringify(allManhwas));
            alert(`ุชู ุญูุธ ุจูุงูุงุช ุงููุงูููุง "${name}" ุจูุฌุงุญ.`);
            populateExistingManhwaDropdown(allManhwas);
        }

        function loadManhwaForEditing() {
            const selectedName = document.getElementById('existingManhwa').value;
            chaptersContainer.innerHTML = '';
            document.getElementById('finalHtmlCode').textContent = 'ุชู ุชููุฆุฉ ุงููุงุฌูุฉ ููุงูููุง ุฌุฏูุฏุฉ.';

            if (!selectedName) {
                manhwaData = { name: '', story: '', genre: '', status: 'ูุณุชูุฑุฉ', chapterCount: '', chapters: [] };
                document.getElementById('manhwaName').value = '';
                document.getElementById('manhwaStory').value = '';
                document.getElementById('manhwaGenre').value = '';
                document.getElementById('manhwaStatus').value = 'ูุณุชูุฑุฉ';
                document.getElementById('chapterCount').value = '';
                if (getChapterElements().length === 0) { addChapter(null); }
                return;
            }

            const allManhwas = loadManhwasList();
            if (allManhwas[selectedName]) {
                manhwaData = JSON.parse(JSON.stringify(allManhwas[selectedName]));
                document.getElementById('manhwaName').value = manhwaData.name;
                document.getElementById('manhwaStory').value = manhwaData.story;
                document.getElementById('manhwaGenre').value = manhwaData.genre;
                document.getElementById('manhwaStatus').value = manhwaData.status;
                document.getElementById('chapterCount').value = manhwaData.chapterCount || '';
                if (manhwaData.chapters.length === 0) {
                    addChapter(null);
                } else {
                    manhwaData.chapters.forEach(chap => { addChapter(chap); });
                }
                document.getElementById('finalHtmlCode').textContent = 'ุชู ุชุญููู ุจูุงูุงุช ุงููุงูููุง ุจูุฌุงุญ.';
            }
        }
        
        function updateManhwaDataFromDOM() {
            manhwaData.chapters = [];
            getChapterElements().forEach((chapterElement, index) => {
                const chapterID = chapterElement.getAttribute('data-chapter-id');
                const chapterName = chapterElement.querySelector('.chapter-name').value.trim();
                const base64Links = [];
                chapterElement.querySelectorAll('.image-input-group').forEach(imageGroup => {
                    const base64Input = imageGroup.querySelector('.base64-link');
                    if (base64Input.value) { base64Links.push(base64Input.value); }
                });

                if (base64Links.length > 0) {
                    manhwaData.chapters.push({
                        id: chapterID,
                        name: chapterName || `ุงููุตู ${index + 1}`,
                        base64Links: base64Links
                    });
                }
            });
        }

        // Chapter/Image UI Functions
        function addChapter(chapterData = null) {
            const template = document.getElementById('chapterTemplate');
            const chapterClone = template.content.cloneNode(true).querySelector('.chapter-section');
            const chapterID = chapterData ? chapterData.id : generateUUID();
            chapterClone.setAttribute('data-chapter-id', chapterID);
            const chapterNum = getChapterElements().length + 1;
            chapterClone.querySelector('.chapter-number').textContent = chapterNum;
            chapterClone.querySelector('h3').textContent = `ุงููุตู ุฑูู ${chapterNum}`;
            chapterClone.querySelector('.chapter-name').value = chapterData ? chapterData.name : `ุงููุตู ${chapterNum}`;
            chaptersContainer.appendChild(chapterClone);
            
            const imagesContainer = chapterClone.querySelector('.images-container');
            if (chapterData && chapterData.base64Links.length > 0) {
                 imagesContainer.innerHTML = ''; 
                 chapterData.base64Links.forEach((link) => { addImageInput(chapterClone, link); });
            } else {
                 if (imagesContainer.querySelectorAll('.image-input-group').length === 0) { addImageInput(chapterClone, ''); }
            }
            updateChapterNumbers();
        }

        function addImageInput(chapterElement, base64Link = '') {
            const imagesContainer = chapterElement.querySelector('.images-container');
            const imageTemplate = document.getElementById('imageInputTemplate');
            const imageClone = imageTemplate.content.cloneNode(true).querySelector('.image-input-group');
            const imageID = generateUUID();
            imageClone.setAttribute('data-image-id', imageID);
            imageClone.querySelector('.base64-link').value = base64Link;
            imagesContainer.appendChild(imageClone);
            if (base64Link) {
                 displayImagePreview(chapterElement.querySelector('.preview-container'), imageID, base64Link);
            }
            updateImageNumbers(chapterElement);
            return imageClone;
        }

        function removeChapter(chapterElement) {
            const chapterID = chapterElement.getAttribute('data-chapter-id');
            if (!confirm(`ูู ุฃูุช ูุชุฃูุฏ ูู ุฅุฒุงูุฉ ุงููุตู ุฑูู ${chapterElement.querySelector('.chapter-number').textContent}ุ`)) return;
            chapterElement.remove();
            manhwaData.chapters = manhwaData.chapters.filter(c => c.id !== chapterID);
            updateChapterNumbers();
        }

        function removeLastImage(chapterElement) {
            const imageGroups = chapterElement.querySelectorAll('.image-input-group');
            if (imageGroups.length > 0) {
                const lastImageGroup = imageGroups[imageGroups.length - 1];
                removeImage(lastImageGroup);
            } else {
                 alert("ูุง ุชูุฌุฏ ุตูุฑ ูููู ุญุฐููุง.");
            }
        }
        
        function removeImage(imageGroup) {
            const imageID = imageGroup.getAttribute('data-image-id');
            const chapterElement = imageGroup.closest('.chapter-section');
            if (imageGroup) {
                imageGroup.remove();
                const img = chapterElement.querySelector(`.preview-container img[data-image-id="${imageID}"]`);
                if (img) img.remove();
                updateImageNumbers(chapterElement);
            }
        }
        
        function updateChapterNumbers() {
            getChapterElements().forEach((chapterElement, index) => {
                const chapterNum = index + 1;
                chapterElement.querySelector('.chapter-number').textContent = chapterNum;
                chapterElement.querySelector('h3').textContent = `ุงููุตู ุฑูู ${chapterNum}`;
                updateImageNumbers(chapterElement);
            });
        }
        
        function updateImageNumbers(chapterElement) {
             chapterElement.querySelectorAll('.image-input-group').forEach((imageGroup, index) => {
                imageGroup.querySelector('.image-number').textContent = index + 1;
            });
        }

        function displayImagePreview(previewContainer, imageID, base64String) {
            const img = previewContainer.querySelector(`img[data-image-id="${imageID}"]`) || document.createElement('img');
            img.setAttribute('data-image-id', imageID);
            img.src = base64String;
            if (!previewContainer.contains(img)) { previewContainer.appendChild(img); }
        }

        function previewImageHandler(fileInput) {
            const chapterElement = fileInput.closest('.chapter-section');
            
            if (fileInput.hasAttribute('multiple')) {
                const files = fileInput.files;
                if (!files.length) return;
                
                // Clear existing empty image inputs before loading multiple
                chapterElement.querySelectorAll('.image-input-group').forEach(group => {
                    if (!group.querySelector('.base64-link').value) group.remove();
                });
                
                let fileIndex = 0;
                function processNextFile() {
                    if (fileIndex < files.length) {
                        const file = files[fileIndex];
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const base64String = e.target.result;
                            addImageInput(chapterElement, base64String);
                            fileIndex++;
                            processNextFile();
                        };
                        reader.readAsDataURL(file);
                    }
                }
                processNextFile();
                return;
            }
            
            const imageGroup = fileInput.closest('.image-input-group');
            const imageID = imageGroup.getAttribute('data-image-id');
            const file = fileInput.files[0];
            const previewContainer = chapterElement.querySelector('.preview-container');
            const base64HiddenInput = imageGroup.querySelector('.base64-link');

            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const base64String = e.target.result;
                    base64HiddenInput.value = base64String; 
                    displayImagePreview(previewContainer, imageID, base64String);
                };
                reader.readAsDataURL(file);
            } else {
                base64HiddenInput.value = '';
                const img = previewContainer.querySelector(`img[data-image-id="${imageID}"]`);
                if (img) img.remove();
            }
        }
        
        // =================================================================
        // CODE GENERATION
        // =================================================================

        function generateBase64AndCode() {
            if (!document.getElementById('manhwaName').value.trim()) { alert("ุงูุฑุฌุงุก ุฅุฏุฎุงู ุงุณู ุงููุงูููุง ุฃููุงู."); return; }
            updateManhwaDataFromDOM();
            let chaptersHtml = '';
            manhwaData.chapters.forEach((chapter) => {
                const imagesHtml = chapter.base64Links.map(link => 
                    `    <img src="${link}" alt="ุตูุฑุฉ ${chapter.name}">`
                ).join('\n');
                chaptersHtml += `
<div class="chapter">
    <h2>${chapter.name}</h2>
${imagesHtml}
</div>
            `;
            });
            
            const finalCode = `
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${manhwaData.name} - ูุฑุงุกุฉ ุงููุตูู</title>
    <style>
        body { font-family: 'Arial', sans-serif; background-color: #222; color: #fff; text-align: center; margin: 0; padding: 0; }
        .manhwa-info { background: #333; padding: 20px; border-radius: 0; margin-bottom: 0; }
        .manhwa-info h1 { color: #fff; border-bottom: 1px solid #555;
